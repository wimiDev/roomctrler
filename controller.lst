C51 COMPILER V9.00   CONTROLLER                                                            04/12/2017 11:23:47 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE CONTROLLER
OBJECT MODULE PLACED IN controller.obj
COMPILER INVOKED BY: I:\program\keil\C51\BIN\C51.EXE class\controller.c LARGE BROWSE DEBUG OBJECTEXTEND PRINT(.\controll
                    -er.lst) OBJECT(controller.obj)

line level    source

   1          #include"controller.h"
   2          unsigned char paralist[4];
   3          unsigned char _page = 0;
   4          unsigned char lvsecond = 0;
   5           unsigned char number = 0;
   6          DATE currenttime;
   7          DATE closetime;//关灯时间
   8          DATE opentime;//开灯时间
   9          
  10          void controllerinit()
  11          {               
  12   1              Initial_DS1302();
  13   1              DS1302_SetTime(DS1302_HOUR,10); //??????????10??54??30
  14   1              DS1302_SetTime(DS1302_MINUTE,54);
  15   1              DS1302_SetTime(DS1302_SECOND,30); 
  16   1              dbinit();
  17   1      
  18   1              closetime.hour = 0;
  19   1              closetime.min = 0;
  20   1              closetime.sec = 0;  
  21   1      
  22   1              opentime.hour = 0;
  23   1              opentime.min = 0;
  24   1              opentime.sec = 0; 
  25   1      
  26   1              LCD_init();  //初始化LCD模块 
  27   1              LCDcls(); //清屏幕      
  28   1      }
  29          //void setparas(char*list)
  30          //{
  31          //
  32          //}
  33          void parafilter(unsigned char* list,char size)
  34          {
  35   1              char i=0;
  36   1              //char sendstr[30];
  37   1              unsigned char val = 0;
  38   1              char id =  list[0]-'0';
  39   1              if (RevTempDate0[0]==0)
  40   1              {
  41   2                      return;
  42   2              }
  43   1              for(i=1;i<size;i++)
  44   1              {
  45   2                      val = (val*10)+(list[i]-'0');           
  46   2              }
  47   1              if(id==1)
  48   1              {
  49   2                      paralist[0] = val;      
  50   2              }
  51   1              else if(id==2)
  52   1              {
  53   2                      paralist[1] = val;      
  54   2              } 
C51 COMPILER V9.00   CONTROLLER                                                            04/12/2017 11:23:47 PAGE 2   

  55   1              else if(id==3)
  56   1              {
  57   2                      paralist[2] = val;      
  58   2              }
  59   1              else if(id==4)
  60   1              {
  61   2                      paralist[3] = val;
  62   2              }
  63   1              else
  64   1              {
  65   2                      for(i=0;i<5;++i)
  66   2                      {
  67   3                              RevTempDate0[i] = 0;    
  68   3                      }
  69   2                      return;
  70   2              }       
  71   1              //置空接收区
  72   1              for(i=0;i<5;++i)
  73   1              {
  74   2                      RevTempDate0[i] = 0;    
  75   2              }
  76   1      }
  77          void getcutrrenttime()
  78          {  
  79   1      //      char str[20];
  80   1              SYSTEMTIME CurrentTime;
  81   1              DS1302_GetTime(&CurrentTime);
  82   1              //DateToStr(&CurrentTime);
  83   1              TimeToStr(&CurrentTime);
  84   1              currenttime.hour=CurrentTime.Hour;
  85   1              currenttime.min=CurrentTime.Minute;
  86   1              currenttime.sec=CurrentTime.Second;
  87   1      //      sprintf(str,"[%d:%d:%d]",(int)currenttime.hour,(int)currenttime.min,(int)currenttime.sec);
  88   1      //      //SendString(str);
  89   1      //      LCDcls();
  90   1      //      LCDprintf("-TIME-NOW-");
  91   1      //      LCDprintf(str);
  92   1      }
  93          void showtimeval(DATE* time,char*name)
  94          {
  95   1               char str[20];
  96   1               sprintf(str,"[%d:%d:%d]",(int)time->hour,(int)time->min,(int)time->sec);
  97   1              //SendString(str);
  98   1              LCDcls();
  99   1              LCDprintf(name);
 100   1              LCDprintf(str);
 101   1      }
 102          void trunpage()
 103          {
 104   1              if(lvsecond==0)
 105   1              {
 106   2                      if(getkey(0)==15)
 107   2                      {
 108   3                      //上翻页
 109   3                              _page++;
 110   3                              if (_page >= MAXPAGE) _page = 0;
 111   3                      }
 112   2                      if(getkey(0)==11)
 113   2                      {
 114   3                      //下翻页
 115   3                              --_page;
 116   3                              if (_page>MAXPAGE-1)    _page = MAXPAGE-1;
C51 COMPILER V9.00   CONTROLLER                                                            04/12/2017 11:23:47 PAGE 3   

 117   3                      }
 118   2              }
 119   1      }
 120          void uiupdater()
 121          {
 122   1              char sendstr[30];
 123   1              trunpage();
 124   1              if (_page == 0)
 125   1              { 
 126   2                      LCDcls();
 127   2                      LCDprintf("--wellcom-----use----WIMI-DEV-");    
 128   2              }
 129   1              else if (_page==1)
 130   1              {
 131   2                      sprintf(sendstr,"a%d,b%d,c%d,d%d",(int)paralist[0],
 132   2                                 (int)paralist[1],(int)paralist[2],(int)paralist[3]);
 133   2                      //SendString(sendstr);
 134   2                      LCDcls();
 135   2                      LCDprintf(sendstr);     
 136   2              }
 137   1              else if (_page==2)
 138   1              {
 139   2                      
 140   2                      if(lvsecond==0) showtimeval(&currenttime,"-TIME-NOW-");
 141   2                      setcurrenttime();
 142   2              }
 143   1              else if(_page == 3)
 144   1              {
 145   2                      setclosetime(&opentime);
 146   2                      if(lvsecond==0) showtimeval(&opentime,"OPEN-TIME-");
 147   2                      //if(timecmp(opentime,))        
 148   2              }
 149   1              else if(_page == 4)
 150   1              {
 151   2                      setclosetime(&closetime);
 152   2                      if(lvsecond==0) showtimeval(&closetime,"-OFF-TIME-");
 153   2              }       
 154   1              getkey(1);
 155   1      }
 156          void cashcard(unsigned char *resdata)
 157          {
 158   1              unsigned char index = 0; 
 159   1              unsigned char len = getuartbuflen();
 160   1              unsigned char idsta[10]; 
 161   1              unsigned char insertindex = 0;
 162   1              unsigned char selectindex = 0;
 163   1              char str[20]="cashcard"; 
 164   1              if(getreaded()) return;//没有数据更新
 165   1              LCDcls();
 166   1              for(index=0;index< len;index++)
 167   1              {       
 168   2                      if(index>4&&index<len)
 169   2                      { 
 170   3                              idsta[index-5] = *(resdata+index);      
 171   3                      }
 172   2                      setread(1);
 173   2                      *(resdata+index) = 0;//清空数据
 174   2              }
 175   1              selectindex =  selectid(idsta);
 176   1              if(selectindex != UNKNOWERROR)
 177   1              {
 178   2                      //查找到了
C51 COMPILER V9.00   CONTROLLER                                                            04/12/2017 11:23:47 PAGE 4   

 179   2                      number--;
 180   2                      delectidbyindex(selectindex);
 181   2                      sprintf(str,"NO.%d-OUT-;number is.%d.",(int)selectindex,(int)number);
 182   2              }
 183   1              else
 184   1              {
 185   2                      //没有找到
 186   2                      insertindex = insertid(idsta);
 187   2                      if(insertindex == UNKNOWERROR) 
 188   2                      {
 189   3                              LCDprintf("--FULL--");
 190   3                              LCDprintf("--callme--13077661594");
 191   3                              return;
 192   3                      } 
 193   2                      number++;
 194   2                      sprintf(str,"NO.%d-IN-;number is。%d。",(int)insertindex,(int)number);
 195   2              }
 196   1              LCDprintf(str); 
 197   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    975    ----
   CONSTANT SIZE    =    193    ----
   XDATA SIZE       =     22     123
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
